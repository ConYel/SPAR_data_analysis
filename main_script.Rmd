---
title: "Main_Data_Analysis"
author: "Constantinos Yeles"
date: "10/07/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r install_libraries}
BiocManager::install(c("wesanderson","edgeR","rafalib","derfinderPlot"))

```

```{r load_libraries}
library(tidyverse);library(wesanderson);library(edgeR);library(rafalib)
suppressPackageStartupMessages(library('derfinder'))
suppressPackageStartupMessages(library('tidyverse'))
suppressPackageStartupMessages(library('wesanderson'))
suppressPackageStartupMessages(library('edgeR'))
suppressPackageStartupMessages(library('rafalib'))
suppressPackageStartupMessages(library('data.table'))
```

```{r date_of_analysis}
date <- gsub(" ","_",format(Sys.time(), "%b %d %Y"))
```


```{r create_the_matrix}
path <- "/home/"
smallRNA_files <- list.files(path,pattern = "smRNA_gene_expression.xls", recursive = TRUE)
smallRNA_files <- str_glue("{path}{smallRNA_files}")
#load the list of files in one table
DT <- rbindlist(sapply(smallRNA_files,fread,
                       simplify=FALSE,
                       #select = c(1,2,4,6),
                       verbose=getOption("datatable.verbose", TRUE)),
                use.names= TRUE,idcol="file")  %>%
  rename(smallRNA= "#Gene")

#sep first column to multiple
#  separate("#Gene",c("chr","start","end","strand","smallRNA","DQ"), sep = ":") %>% 
#  as_tibble()
#make matrix for DE analysis
dt <- DT %>% group_by(file) %>% select(-RPM) %>%
  spread(key = "file", value = "ReadCount" )
# clean the colnames
names(dt)[3:length(names(dt))] <- names(dt)[3:length(names(dt))] %>% 
  str_remove("/home/") %>% 
  str_remove(".trimmed_.+") %>% 
  str_replace("^?","S")
  
targets_file <- fread("/home/tex.xls") %>% 
  as_tibble() %>% 
  select(samples,my_col, tissue, total_region, S_P, dev_stage, Reads, Note, Sample_ID, Sex, Years) %>% 
  mutate(my_col = str_replace(my_col,"^?","S"))

target <- match(names(dt),targets_file$my_col,nomatch = 0)
dt1 <- dt
names(dt1)[names(dt1) %in% targets_file$my_col] <- as.character(targets_file$my_col[target])
tibble(names(dt1), names(dt)) %>% view()

dt %>% write_tsv("results_matrix_SPAR.txt")
```


